# IoT Starter Raspberry Pi Lumi

#### Home Intelligence with Raspberry Pi

### IoT.Starter.Pi.Thing for a Universal Remote Control

## Introduction

This series, targeted to Raspberry Pi with Linux,  started with [IoT.Starter.Pi.Core](https://www.codeproject.com/Articles/1220930/IoT-Starter-Raspberry-Pi-Core) using API First Design strategy  to develop an ASP.NET Core Web Server automatically generated by Swagger Hub.

The second part introduced  [IoT.Starter.Pi.Thing](https://www.codeproject.com/Articles/1224347/IoT-Starter-Raspberry-Pi-Thing), an  embryo for Home Intelligence using Raspberry Pi with Linux. 
Designed as a starter kit for IoT initiatives, it provides a solid and structured platform to speed up product development. The  [starter kit concept](https://www.codeproject.com/Articles/1122233/IoT-Starter-Core-for-Netduino-Plus) encourages the teams to start working immediately on the product development.

The third part [IoT.Starter.Pi.Lirc](https://www.codeproject.com/Articles/1226559/IoT-Starter-Raspberry-Pi-Lirc) is dedicated to IoT projects that require infrared devices. A test environment is created by a `Console` powered by Lirc, the Linux Infrared Remote Control.  The `Thing` is now able to benefit from what we learned from these tests.

The objective now is to extend the `Thing` web services to allow IR remotes and  their respective codes to be considered by the API. Powered by Lirc, the `IoT.Starter.Pi.Thing` can be useful on IoT initiatives that require infrared support.

## API first

Following the API first strategy, a new [API version 1.0.2](https://app.swaggerhub.com/apis/motta/home/1.0.2) is created and summarized at picture below, adding a `RemoteApi` controller to existing specification. The `GET` operations should identify remotes and their respective IR codes. The `POST` operation reflects the intention to fire IR blasts for remotes already installed at RPI host, using Lirc software.     

![](https://i.imgur.com/Mb5TWpO.png)

### Generate RemoteApi

SwaggerHub generates automatically the `RemoteApi` controller code, according to instructions already explained at [IoT.Starter.Pi.Core](https://www.codeproject.com/Articles/1220930/IoT-Starter-Raspberry-Pi-Core) in the section "Upgrading the API". Please take a look if you have any doubts. Then the generated code was tweaked to fit the specification objectives, resulting on the following:

    public class RemoteApiController : Controller
    { 
        /// <summary>
        /// 
        /// </summary>
        /// <remarks>returns ir code from remote</remarks>
        /// <param name="remote">Lirc remote</param>
        /// <param name="code">ir code</param>
        /// <response code="200">All the codes</response>
        [HttpGet]
        [Route("/motta/home/1.0.1/remotes/{remote}/{code}")]
        [ValidateModelState]
        [SwaggerOperation("GetRemoteCode")]
        [SwaggerResponse(200, typeof(List<string>), "All the codes")]
        public virtual IActionResult GetRemoteCode([FromRoute]string remote, [FromRoute]string code)
        {
            string example = ("/usr/bin/irsend list " + remote + " " + code).Bash();

            return new ObjectResult(example);
        }

        /// <summary>
        /// 
        /// </summary>
        /// <remarks>returns all ir codes from remote</remarks>
        /// <param name="remote">Lirc remote</param>
        /// <response code="200">All the codes</response>
        [HttpGet]
        [Route("/motta/home/1.0.1/remotes/{remote}")]
        [ValidateModelState]
        [SwaggerOperation("GetRemoteCodes")]
        [SwaggerResponse(200, typeof(List<string>), "All the codes")]
        public virtual IActionResult GetRemoteCodes([FromRoute]string remote)
        {
            string example = (@"/usr/bin/irsend list " + remote + @" """"").Bash();

            return new ObjectResult(example);
        }

        /// <summary>
        /// 
        /// </summary>
        /// <remarks>returns all installed remotes</remarks>
        /// <param name="skip">number of records to skip</param>
        /// <param name="limit">max number of records to return</param>
        /// <response code="200">All the installed remotes</response>
        [HttpGet]
        [Route("/motta/home/1.0.1/remotes")]
        [ValidateModelState]
        [SwaggerOperation("GetRemotes")]
        [SwaggerResponse(200, typeof(List<string>), "All the installed remotes")]
        public virtual IActionResult GetRemotes([FromQuery]int? skip, [FromQuery]int? limit)
        {
            string example = (@"/usr/bin/irsend list """" """"").Bash();

            return new ObjectResult(example);
        }

        /// <summary>
        /// 
        /// </summary>
        /// <remarks>flashes ir code simulating the remote control</remarks>
        /// <param name="remote">Lirc remote</param>
        /// <param name="code">ir code</param>
        /// <response code="200">response</response>
        [HttpPost]
        [Route("/motta/home/1.0.1/remotes/{remote}/{code}")]
        [ValidateModelState]
        [SwaggerOperation("SendRemoteCode")]
        [SwaggerResponse(200, typeof(ApiResponse), "response")]
        public virtual IActionResult SendRemoteCode([FromRoute]string remote, [FromRoute]string code)
        {
            string example = (@"/usr/bin/irsend send_once " + remote + " " + code).Bash();

            return new ObjectResult(example);
        }
    }
 
You can notice that `irsend` commands are used in all operations! The `HttpGet` operations identify IR remotes and their respective codes. For example, to list all installed remotes, the following command is issued:

	pi@lumi:~ $ irsend list "" ""
	

The code equivalent is shown below:

        public virtual IActionResult GetRemotes([FromQuery]int? skip, [FromQuery]int? limit)
        {
            string example = (@"/usr/bin/irsend list """" """"").Bash();

            return new ObjectResult(example);
        }

The `HttpPost` operation get `remote` and `code` parameters to blast the command through the IR output. Please see again the details at `SendRemoteCode` below: 

        public virtual IActionResult SendRemoteCode([FromRoute]string remote, [FromRoute]string code)
        {
            string example = (@"/usr/bin/irsend send_once " + remote + " " + code).Bash();

            return new ObjectResult(example);
        }

